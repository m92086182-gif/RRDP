name: Windows 10 RDP Premium (30 Days)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 */3 * *"

jobs:
  premium-rdp:
    runs-on: windows-latest
    timeout-minutes: 4320

    steps:
    - name: Configure Maximum Performance
      run: |
        # ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù„ÙŠ
        powercfg /setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
        
        # ØªØ­Ø³ÙŠÙ† Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø©
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" -Name "ClearPageFileAtShutdown" -Value 0
        
        # ØªØ¹Ø·ÙŠÙ„ Ù…ØªØ·Ù„Ø¨Ø§Øª ØªØ¹Ù‚ÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        secedit /export /cfg C:\secpol.cfg
        ((Get-Content C:\secpol.cfg) -replace "PasswordComplexity = 1", "PasswordComplexity = 0") | Set-Content C:\secpol.cfg
        ((Get-Content C:\secpol.cfg) -replace "MinimumPasswordLength = 7", "MinimumPasswordLength = 1") | Set-Content C:\secpol.cfg
        secedit /configure /db C:\Windows\security\local.sdb /cfg C:\secpol.cfg /areas SECURITYPOLICY
        Remove-Item C:\secpol.cfg -Force
        
        # ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª ØºÙŠØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©
        $servicesToDisable = @(
            "XboxGipSvc",
            "XboxNetApiSvc", 
            "WSearch",
            "TabletInputService",
            "MapsBroker",
            "lfsvc"
        )
        
        foreach ($service in $servicesToDisable) {
            try {
                Stop-Service -Name $service -Force -ErrorAction SilentlyContinue
                Set-Service -Name $service -StartupType Disabled -ErrorAction SilentlyContinue
                Write-Host "âœ… Disabled service: $service"
            } catch {
                Write-Host "âš ï¸ Could not disable service: $service"
            }
        }

    - name: Enable RDP with Admin Rights
      run: |
        # ØªÙØ¹ÙŠÙ„ RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
        
        # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª RDP Ù…ØªÙ‚Ø¯Ù…Ø© Ù„Ù„Ø£Ø¯Ø§Ø¡
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxInstanceCount" -Value 4294967295
        
        # Ø¬Ø¯Ø§Ø± Ø§Ù„Ø­Ù…Ø§ÙŠØ©
        netsh advfirewall firewall add rule name="RDP-Premium" dir=in action=allow protocol=TCP localport=3389
        Restart-Service -Name TermService -Force
        Write-Host "âœ… RDP enabled and configured"

    - name: Create Admin User with Strong Password
      run: |
        # Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù‚ÙˆÙŠØ© ØªØ³ØªÙˆÙÙŠ Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
        $password = "Windows10RDP@2024!"
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ù„ÙŠØ³ ÙØ§Ø±ØºØ§Ù‹
        if ([string]::IsNullOrWhiteSpace($password)) {
            Write-Error "âŒ Password is empty!"
            exit 1
        }
        
        Write-Host "Creating user with password: $password"
        $securePass = ConvertTo-SecureString $password -AsPlainText -Force
        
        # Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
        if (Get-LocalUser -Name "AdminUser" -ErrorAction SilentlyContinue) {
            Remove-LocalUser -Name "AdminUser"
            Write-Host "âœ… Removed existing AdminUser"
        }
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
        try {
            New-LocalUser -Name "AdminUser" -Password $securePass -AccountNeverExpires -FullName "Administrator" -Description "RDP Admin User"
            Write-Host "âœ… User created successfully"
        } catch {
            Write-Host "âŒ Failed to create user with first method, trying alternative..."
            # Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            net user AdminUser "$password" /add /fullname:"Administrator" /comment:"RDP Admin User" /expires:never /passwordchg:no
        }
        
        # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
        Add-LocalGroupMember -Group "Administrators" -Member "AdminUser"
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "AdminUser"
        Add-LocalGroupMember -Group "Remote Management Users" -Member "AdminUser"
        
        Write-Host "âœ… Admin user created successfully with password: Windows10RDP@2024!"

    - name: Install Essential Software
      run: |
        # ØªØ«Ø¨ÙŠØª Chrome
        $chromeUrl = "https://dl.google.com/tag/s/appguid%3D%7B8A69D345-D564-463C-AFF1-A69D9E530F96%7D%26iid%3D%7B807C7F79-8B02-11F9-B11A-5C5394DFDCEB%7D%26lang%3Den%26browser%3D4%26usagestats%3D1%26appname%3DGoogle%2520Chrome%26needsadmin%3Dprefers%26ap%3Dx64-stable-statsdef_2%26installdataindex%3Dempty/chrome/install/ChromeStandaloneSetup64.exe"
        $chromePath = "$env:TEMP\chrome_installer.exe"
        
        try {
            Invoke-WebRequest -Uri $chromeUrl -OutFile $chromePath
            Start-Process -FilePath $chromePath -ArgumentList "/silent", "/install" -Wait
            Remove-Item $chromePath -Force
            Write-Host "âœ… Chrome installed successfully"
        } catch {
            Write-Host "âš ï¸ Failed to install Chrome"
        }

        # ØªØ«Ø¨ÙŠØª 7-Zip
        try {
            $7zipUrl = "https://www.7-zip.org/a/7z2409-x64.msi"
            $7zipPath = "$env:TEMP\7zip.msi"
            Invoke-WebRequest -Uri $7zipUrl -OutFile $7zipPath
            Start-Process msiexec.exe -ArgumentList "/i", "`"$7zipPath`"", "/quiet", "/norestart" -Wait
            Remove-Item $7zipPath -Force
            Write-Host "âœ… 7-Zip installed successfully"
        } catch {
            Write-Host "âš ï¸ Failed to install 7-Zip"
        }

    - name: Install Tailscale
      run: |
        $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-amd64.msi"
        $installerPath = "$env:TEMP\tailscale.msi"
        
        try {
            Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
            Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
            Remove-Item $installerPath -Force
            Write-Host "âœ… Tailscale installed successfully"
        } catch {
            Write-Error "âŒ Failed to install Tailscale"
            exit 1
        }

    - name: Connect to Tailscale Network
      run: |
        try {
            & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=win10-premium-$env:GITHUB_RUN_ID --accept-routes=true --accept-dns=true
            
            $tsIP = $null
            $retries = 0
            while (-not $tsIP -and $retries -lt 25) {
                $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
                Start-Sleep -Seconds 3
                $retries++
            }
            
            if (-not $tsIP) {
                Write-Error "âŒ Tailscale IP not assigned after 25 retries"
                exit 1
            }
            
            echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
            Write-Host "âœ… Tailscale connected - IP: $tsIP"
            
        } catch {
            Write-Error "âŒ Failed to connect to Tailscale"
            exit 1
        }

    - name: Final System Optimization
      run: |
        # ØªØ­Ø³ÙŠÙ†Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„Ù„Ù†Ø¸Ø§Ù…
        Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -Name "EnableLUA" -Value 0 -Force
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem" -Name "LongPathsEnabled" -Value 1 -Force
        
        # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
        Remove-Item "$env:TEMP\*" -Recurse -Force -ErrorAction SilentlyContinue
        Cleanmgr /sagerun:1 | Out-Null
        
        Write-Host "âœ… System optimization completed"

    - name: Verify RDP Connection
      run: |
        try {
            Write-Host "ğŸ” Testing RDP connection on IP: $env:TAILSCALE_IP"
            $test = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389 -WarningAction SilentlyContinue
            if ($test.TcpTestSucceeded) {
                Write-Host "âœ… RDP connection verified successfully!"
            } else {
                Write-Host "âŒ RDP connection failed - restarting Terminal Service"
                Restart-Service -Name TermService -Force
                Start-Sleep -Seconds 10
                # Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„
                $test = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389 -WarningAction SilentlyContinue
                if ($test.TcpTestSucceeded) {
                    Write-Host "âœ… RDP connection working after restart!"
                }
            }
        } catch {
            Write-Host "âš ï¸ RDP test encountered an error"
        }

    - name: Display RDP Details
      run: |
        Write-Host ""
        Write-Host "ğŸ‰ PREMIUM WINDOWS 10 RDP READY ğŸ‰"
        Write-Host "========================================"
        Write-Host "ğŸŒ Address: $env:TAILSCALE_IP"
        Write-Host "ğŸ‘¤ Username: AdminUser"
        Write-Host "ğŸ”‘ Password: Windows10RDP@2024!"
        Write-Host "â° Duration: 72 Hours"
        Write-Host "ğŸ’» Admin Rights: âœ… Full Access"
        Write-Host "ğŸ› ï¸  Installed: Chrome, 7-Zip, Tailscale"
        Write-Host "========================================"
        Write-Host "ğŸ“‹ Connection Instructions:"
        Write-Host "1. Open Remote Desktop Connection"
        Write-Host "2. Enter the IP address above"
        Write-Host "3. Username: AdminUser"
        Write-Host "4. Password: Windows10RDP@2024!"
        Write-Host "5. Click Connect and enjoy!"
        Write-Host ""

    - name: Keep Session Active
      run: |
        Write-Host "ğŸŸ¢ RDP Session Started - Keeping alive for 72 hours..."
        Write-Host "ğŸ’¡ You can now connect using the details above"
        
        for ($i=0; $i -lt 864; $i++) {
            $remaining = (864 - $i) * 5
            $hours = [math]::Floor($remaining / 60)
            $minutes = $remaining % 60
            
            # Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ÙƒÙ„ 30 Ø¯Ù‚ÙŠÙ‚Ø©
            if ($i % 6 -eq 0) {
                try {
                    $test = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389 -WarningAction SilentlyContinue
                    $status = if ($test.TcpTestSucceeded) { "âœ… Connected" } else { "âŒ Disconnected" }
                    Write-Host "â±ï¸  RDP Active - $hoursh $minutesm remaining - Status: $status"
                } catch {
                    Write-Host "â±ï¸  RDP Active - $hoursh $minutesm remaining - Status: âš ï¸ Checking..."
                }
            } else {
                Write-Host "â±ï¸  RDP Active - $hoursh $minutesm remaining"
            }
            
            Start-Sleep -Seconds 300
        }
        
        Write-Host "ğŸ›‘ RDP Session Ended - 72 hours completed"
