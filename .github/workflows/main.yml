name: Windows 10 RDP Premium (30 Days)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 */3 * *"

jobs:
  premium-rdp:
    runs-on: windows-latest
    timeout-minutes: 4320

    steps:
    - name: Configure Maximum Performance
      run: |
        # ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù„ÙŠ
        powercfg /setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
        
        # ØªØ­Ø³ÙŠÙ† Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø©
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" -Name "ClearPageFileAtShutdown" -Value 0
        
        # ØªØ¹Ø·ÙŠÙ„ Ù…ØªØ·Ù„Ø¨Ø§Øª ØªØ¹Ù‚ÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        secedit /export /cfg C:\secpol.cfg
        ((Get-Content C:\secpol.cfg) -replace "PasswordComplexity = 1", "PasswordComplexity = 0") | Set-Content C:\secpol.cfg
        ((Get-Content C:\secpol.cfg) -replace "MinimumPasswordLength = 7", "MinimumPasswordLength = 1") | Set-Content C:\secpol.cfg
        secedit /configure /db C:\Windows\security\local.sdb /cfg C:\secpol.cfg /areas SECURITYPOLICY
        Remove-Item C:\secpol.cfg -Force
        
        # ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª ØºÙŠØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©
        $servicesToDisable = @(
            "XboxGipSvc",
            "XboxNetApiSvc", 
            "WSearch",
            "TabletInputService",
            "MapsBroker",
            "lfsvc"
        )
        
        foreach ($service in $servicesToDisable) {
            try {
                Stop-Service -Name $service -Force -ErrorAction SilentlyContinue
                Set-Service -Name $service -StartupType Disabled -ErrorAction SilentlyContinue
                Write-Host "âœ… Disabled service: $service"
            } catch {
                Write-Host "âš ï¸ Could not disable service: $service"
            }
        }

    - name: Enable RDP with Admin Rights
      run: |
        # ØªÙØ¹ÙŠÙ„ RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
        
        # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª RDP Ù…ØªÙ‚Ø¯Ù…Ø© Ù„Ù„Ø£Ø¯Ø§Ø¡
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxInstanceCount" -Value 4294967295
        
        # Ø¬Ø¯Ø§Ø± Ø§Ù„Ø­Ù…Ø§ÙŠØ©
        netsh advfirewall firewall add rule name="RDP-Premium" dir=in action=allow protocol=TCP localport=3389
        Restart-Service -Name TermService -Force
        Write-Host "âœ… RDP enabled and configured"

    - name: Create Admin User with Strong Password
      run: |
        # Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù‚ÙˆÙŠØ© ØªØ³ØªÙˆÙÙŠ Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
        $password = "Windows10RDP@2024!"
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ù„ÙŠØ³ ÙØ§Ø±ØºØ§Ù‹
        if ([string]::IsNullOrWhiteSpace($password)) {
            Write-Error "âŒ Password is empty!"
            exit 1
        }
        
        Write-Host "Creating user with password: $password"
        $securePass = ConvertTo-SecureString $password -AsPlainText -Force
        
        # Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
        if (Get-LocalUser -Name "AdminUser" -ErrorAction SilentlyContinue) {
            Remove-LocalUser -Name "AdminUser"
            Write-Host "âœ… Removed existing AdminUser"
        }
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
        try {
            New-LocalUser -Name "AdminUser" -Password $securePass -AccountNeverExpires -FullName "Administrator" -Description "RDP Admin User"
            Write-Host "âœ… User created successfully"
        } catch {
            Write-Host "âŒ Failed to create user with first method, trying alternative..."
            # Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            net user AdminUser "$password" /add /fullname:"Administrator" /comment:"RDP Admin User" /expires:never /passwordchg:no
        }
        
        # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
        Add-LocalGroupMember -Group "Administrators" -Member "AdminUser"
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "AdminUser"
        Add-LocalGroupMember -Group "Remote Management Users" -Member "AdminUser"
        
        Write-Host "âœ… Admin user created successfully with password: Windows10RDP@2024!"

    - name: Install Essential Software
      run: |
        # ØªØ«Ø¨ÙŠØª Chrome
        $chromeUrl = "https://dl.google.com/tag/s/appguid%3D%7B8A69D345-D564-463C-AFF1-A69D9E530F96%7D%26iid%3D%7B807C7F79-8B02-11F9-B11A-5C5394DFDCEB%7D%26lang%3Den%26browser%3D4%26usagestats%3D1%26appname%3DGoogle%2520Chrome%26needsadmin%3Dprefers%26ap%3Dx64-stable-statsdef_2%26installdataindex%3Dempty/chrome/install/ChromeStandaloneSetup64.exe"
        $chromePath = "$env:TEMP\chrome_installer.exe"
        
        try {
            Invoke-WebRequest -Uri $chromeUrl -OutFile $chromePath
            Start-Process -FilePath $chromePath -ArgumentList "/silent", "/install" -Wait
            Remove-Item $chromePath -Force
            Write-Host "âœ… Chrome installed successfully"
        } catch {
            Write-Host "âš ï¸ Failed to install Chrome"
        }

        # ØªØ«Ø¨ÙŠØª 7-Zip
        try {
            $7zipUrl = "https://www.7-zip.org/a/7z2409-x64.msi"
            $7zipPath = "$env:TEMP\7zip.msi"
            Invoke-WebRequest -Uri $7zipUrl -OutFile $7zipPath
            Start-Process msiexec.exe -ArgumentList "/i", "`"$7zipPath`"", "/quiet", "/norestart" -Wait
            Remove-Item $7zipPath -Force
            Write-Host "âœ… 7-Zip installed successfully"
        } catch {
            Write-Host "âš ï¸ Failed to install 7-Zip"
        }

    - name: Install Tailscale with Multiple Fallbacks
      run: |
        Write-Host "ğŸ”§ Installing Tailscale with multiple methods..."
        
        # Ù‚Ø§Ø¦Ù…Ø© URLs Ø¨Ø¯ÙŠÙ„Ø© Ù„Ù€ Tailscale
        $tailscaleUrls = @(
            "https://pkgs.tailscale.com/stable/tailscale-setup-amd64.msi",
            "https://pkgs.tailscale.com/stable/tailscale-setup-x86.msi",
            "https://pkgs.tailscale.com/unstable/tailscale-setup-amd64.msi"
        )
        
        $success = $false
        
        foreach ($tsUrl in $tailscaleUrls) {
            if ($success) { break }
            
            try {
                Write-Host "Trying URL: $tsUrl"
                $installerPath = "$env:TEMP\tailscale_$([System.IO.Path]::GetFileName($tsUrl))"
                
                # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
                Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath -TimeoutSec 30
                
                if (Test-Path $installerPath) {
                    Write-Host "âœ… Downloaded successfully, file size: $((Get-Item $installerPath).Length) bytes"
                    
                    # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ«Ø¨ÙŠØª
                    $process = Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait -PassThru
                    
                    if ($process.ExitCode -eq 0 -or $process.ExitCode -eq 3010) {
                        Write-Host "âœ… Tailscale installed successfully (Exit code: $($process.ExitCode))"
                        $success = $true
                    } else {
                        Write-Host "âš ï¸ Installation failed with exit code: $($process.ExitCode)"
                    }
                }
                
                # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù„Ù
                Remove-Item $installerPath -Force -ErrorAction SilentlyContinue
                
            } catch {
                Write-Host "âŒ Failed with URL: $tsUrl"
                Write-Host "Error: $($_.Exception.Message)"
            }
        }
        
        if (-not $success) {
            Write-Host "ğŸš¨ All Tailscale installation methods failed, trying manual download..."
            try {
                # Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… winget Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹
                winget install -e --id Tailscale.Tailscale --accept-package-agreements --accept-source-agreements
                Write-Host "âœ… Tailscale installed via winget"
                $success = $true
            } catch {
                Write-Host "âš ï¸ Winget installation also failed"
            }
        }
        
        if (-not $success) {
            Write-Host "âš ï¸ Tailscale installation failed, but continuing without it..."
            # Ù„Ø§ Ù†ÙˆÙ‚Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¥Ø°Ø§ ÙØ´Ù„ ØªØ«Ø¨ÙŠØª Tailscale
        }

    - name: Setup Alternative VPN (ZeroTier as Backup)
      run: |
        # Ø¥Ø°Ø§ ÙØ´Ù„ TailscaleØŒ Ù†Ø¬Ø±Ø¨ ZeroTier ÙƒØ¨Ø¯ÙŠÙ„
        if (-not (Test-Path "$env:ProgramFiles\Tailscale\tailscale.exe")) {
            Write-Host "ğŸ”„ Setting up ZeroTier as VPN backup..."
            try {
                $zerotierUrl = "https://download.zerotier.com/dist/ZeroTier%20One.msi"
                $ztPath = "$env:TEMP\zerotier.msi"
                
                Invoke-WebRequest -Uri $zerotierUrl -OutFile $ztPath
                Start-Process msiexec.exe -ArgumentList "/i", "`"$ztPath`"", "/quiet", "/norestart" -Wait
                Remove-Item $ztPath -Force
                
                Write-Host "âœ… ZeroTier installed as backup VPN"
                echo "USING_ZEROTIER=true" >> $env:GITHUB_ENV
            } catch {
                Write-Host "âš ï¸ ZeroTier installation also failed"
                echo "USING_ZEROTIER=false" >> $env:GITHUB_ENV
            }
        } else {
            echo "USING_ZEROTIER=false" >> $env:GITHUB_ENV
        }

    - name: Connect to VPN Network
      run: |
        # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ø¨Ø± Tailscale Ø£ÙˆÙ„Ø§Ù‹
        if (Test-Path "$env:ProgramFiles\Tailscale\tailscale.exe") {
            try {
                Write-Host "ğŸ”— Connecting to Tailscale network..."
                & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=win10-premium-$env:GITHUB_RUN_ID --accept-routes=true --accept-dns=true --reset
                
                $tsIP = $null
                $retries = 0
                while (-not $tsIP -and $retries -lt 30) {
                    $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
                    if (-not $tsIP) {
                        Start-Sleep -Seconds 2
                        $retries++
                    }
                }
                
                if ($tsIP) {
                    echo "VPN_IP=$tsIP" >> $env:GITHUB_ENV
                    echo "VPN_TYPE=tailscale" >> $env:GITHUB_ENV
                    Write-Host "âœ… Tailscale connected - IP: $tsIP"
                } else {
                    Write-Host "âŒ Tailscale connection failed after 30 retries"
                    throw "Tailscale connection failed"
                }
                
            } catch {
                Write-Host "âŒ Tailscale connection error: $($_.Exception.Message)"
            }
        }
        
        # Ø¥Ø°Ø§ ÙØ´Ù„ TailscaleØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø© (RDP Ù…Ø¨Ø§Ø´Ø± Ø¹Ø¨Ø± GitHub)
        if (-not $env:VPN_IP) {
            Write-Host "ğŸ”„ Using direct RDP setup without VPN..."
            # ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ù„Ø©ØŒ Ø³Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù€ runner Ù…Ø¨Ø§Ø´Ø±Ø© (Ù„Ø£ØºØ±Ø§Ø¶æ¼”ç¤º ÙÙ‚Ø·)
            # ÙÙŠ Ø§Ù„ÙˆØ§Ù‚Ø¹ØŒ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø·Ø±ÙŠÙ‚Ø© Ø£Ø®Ø±Ù‰ Ù„Ù„ÙˆØµÙˆÙ„
            echo "VPN_IP=direct-rdp-setup" >> $env:GITHUB_ENV
            echo "VPN_TYPE=direct" >> $env:GITHUB_ENV
        }

    - name: Final System Optimization
      run: |
        # ØªØ­Ø³ÙŠÙ†Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„Ù„Ù†Ø¸Ø§Ù…
        Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -Name "EnableLUA" -Value 0 -Force
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem" -Name "LongPathsEnabled" -Value 1 -Force
        
        # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
        Remove-Item "$env:TEMP\*" -Recurse -Force -ErrorAction SilentlyContinue
        Cleanmgr /sagerun:1 | Out-Null
        
        Write-Host "âœ… System optimization completed"

    - name: Display RDP Details
      run: |
        Write-Host ""
        Write-Host "ğŸ‰ PREMIUM WINDOWS 10 RDP READY ğŸ‰"
        Write-Host "========================================"
        Write-Host "ğŸ”— Connection Type: $env:VPN_TYPE"
        if ($env:VPN_TYPE -eq "tailscale") {
            Write-Host "ğŸŒ VPN Address: $env:VPN_IP"
        } else {
            Write-Host "ğŸŒ Setup: Direct RDP (Check GitHub Runner)"
        }
        Write-Host "ğŸ‘¤ Username: AdminUser"
        Write-Host "ğŸ”‘ Password: Windows10RDP@2024!"
        Write-Host "â° Duration: 72 Hours"
        Write-Host "ğŸ’» Admin Rights: âœ… Full Access"
        Write-Host "ğŸ› ï¸  Installed: Chrome, 7-Zip, VPN Client"
        Write-Host "========================================"
        Write-Host "ğŸ“‹ Connection Instructions:"
        if ($env:VPN_TYPE -eq "tailscale") {
            Write-Host "1. Install Tailscale on your local machine"
            Write-Host "2. Join the same Tailscale network"
            Write-Host "3. Open Remote Desktop Connection"
            Write-Host "4. Enter the IP address: $env:VPN_IP"
            Write-Host "5. Username: AdminUser"
            Write-Host "6. Password: Windows10RDP@2024!"
        } else {
            Write-Host "âš ï¸ VPN setup failed - Manual configuration required"
            Write-Host "Check GitHub Actions logs for alternative setup"
        }
        Write-Host ""

    - name: Keep Session Active
      run: |
        Write-Host "ğŸŸ¢ RDP Session Started - Keeping alive for 72 hours..."
        Write-Host "ğŸ’¡ You can now connect using the details above"
        
        for ($i=0; $i -lt 864; $i++) {
            $remaining = (864 - $i) * 5
            $hours = [math]::Floor($remaining / 60)
            $minutes = $remaining % 60
            
            Write-Host "â±ï¸  RDP Active - $hoursh $minutesm remaining - Type: $env:VPN_TYPE"
            
            Start-Sleep -Seconds 300
        }
        
        Write-Host "ğŸ›‘ RDP Session Ended - 72 hours completed"
