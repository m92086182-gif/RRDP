name: Windows 10 RDP Premium (30 Days)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 */3 * *"

jobs:
  premium-rdp:
    runs-on: windows-latest
    timeout-minutes: 4320

    steps:
    - name: Check if Secrets are Set
      run: |
        if (-not "${{ secrets.RDP_PASSWORD }}") {
            Write-Error "âŒ RDP_PASSWORD secret is not set!"
            Write-Host "Please set RDP_PASSWORD in repository secrets"
            exit 1
        }
        if (-not "${{ secrets.TAILSCALE_AUTH_KEY }}") {
            Write-Error "âŒ TAILSCALE_AUTH_KEY secret is not set!"
            Write-Host "Please set TAILSCALE_AUTH_KEY in repository secrets"
            exit 1
        }
        Write-Host "âœ… All secrets are properly set"

    - name: Configure Maximum Performance
      run: |
        powercfg /setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" -Name "ClearPageFileAtShutdown" -Value 0
        
        $servicesToDisable = @(
            "XboxGipSvc",
            "XboxNetApiSvc", 
            "WSearch",
            "TabletInputService"
        )
        
        foreach ($service in $servicesToDisable) {
            try {
                Stop-Service -Name $service -Force -ErrorAction SilentlyContinue
                Set-Service -Name $service -StartupType Disabled -ErrorAction SilentlyContinue
                Write-Host "Disabled service: $service"
            } catch {
                Write-Host "Could not disable service: $service"
            }
        }

    - name: Enable RDP with Admin Rights
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
        
        netsh advfirewall firewall add rule name="RDP-Premium" dir=in action=allow protocol=TCP localport=3389
        Restart-Service -Name TermService -Force

    - name: Create Admin User
      run: |
        # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù€ secret Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†
        $password = "${{ secrets.RDP_PASSWORD }}"
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ù„ÙŠØ³ ÙØ§Ø±ØºØ§Ù‹
        if ([string]::IsNullOrWhiteSpace($password)) {
            Write-Error "RDP_PASSWORD is empty!"
            exit 1
        }
        
        $securePass = ConvertTo-SecureString $password -AsPlainText -Force
        
        if (Get-LocalUser -Name "AdminUser" -ErrorAction SilentlyContinue) {
            Remove-LocalUser -Name "AdminUser"
        }
        
        New-LocalUser -Name "AdminUser" -Password $securePass -AccountNeverExpires
        Add-LocalGroupMember -Group "Administrators" -Member "AdminUser"
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "AdminUser"
        
        Write-Host "âœ… Admin user created successfully"

    - name: Install Essential Software
      run: |
        $chromeUrl = "https://dl.google.com/tag/s/appguid%3D%7B8A69D345-D564-463C-AFF1-A69D9E530F96%7D%26iid%3D%7B807C7F79-8B02-11F9-B11A-5C5394DFDCEB%7D%26lang%3Den%26browser%3D4%26usagestats%3D1%26appname%3DGoogle%2520Chrome%26needsadmin%3Dprefers%26ap%3Dx64-stable-statsdef_2%26installdataindex%3Dempty/chrome/install/ChromeStandaloneSetup64.exe"
        $chromePath = "$env:TEMP\chrome_installer.exe"
        
        try {
            Invoke-WebRequest -Uri $chromeUrl -OutFile $chromePath
            Start-Process -FilePath $chromePath -ArgumentList "/silent", "/install" -Wait
            Remove-Item $chromePath -Force
            Write-Host "âœ… Chrome installed successfully"
        } catch {
            Write-Host "âš ï¸ Failed to install Chrome"
        }

    - name: Install Tailscale
      run: |
        $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-amd64.msi"
        $installerPath = "$env:TEMP\tailscale.msi"
        
        try {
            Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
            Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
            Remove-Item $installerPath -Force
            Write-Host "âœ… Tailscale installed successfully"
        } catch {
            Write-Error "âŒ Failed to install Tailscale"
            exit 1
        }

    - name: Connect to Tailscale Network
      run: |
        try {
            & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=win10-premium-$env:GITHUB_RUN_ID
            
            $tsIP = $null
            $retries = 0
            while (-not $tsIP -and $retries -lt 20) {
                $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
                Start-Sleep -Seconds 3
                $retries++
            }
            
            if (-not $tsIP) {
                Write-Error "âŒ Tailscale IP not assigned after 20 retries"
                exit 1
            }
            
            echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
            Write-Host "âœ… Tailscale connected - IP: $tsIP"
            
        } catch {
            Write-Error "âŒ Failed to connect to Tailscale"
            exit 1
        }

    - name: Verify RDP Connection
      run: |
        try {
            Write-Host "Testing RDP connection on IP: $env:TAILSCALE_IP"
            $test = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389 -WarningAction SilentlyContinue
            if ($test.TcpTestSucceeded) {
                Write-Host "âœ… RDP connection verified successfully!"
            } else {
                Write-Host "âŒ RDP connection failed - restarting Terminal Service"
                Restart-Service -Name TermService -Force
                Start-Sleep -Seconds 10
            }
        } catch {
            Write-Host "âš ï¸ RDP test encountered an error"
        }

    - name: Display RDP Details
      run: |
        Write-Host ""
        Write-Host "ğŸ‰ WINDOWS 10 RDP READY ğŸ‰"
        Write-Host "========================================"
        Write-Host "ğŸŒ Address: $env:TAILSCALE_IP"
        Write-Host "ğŸ‘¤ Username: AdminUser"
        Write-Host "ğŸ”‘ Password: (From RDP_PASSWORD secret)"
        Write-Host "â° Duration: 72 Hours"
        Write-Host "ğŸ’» Admin Rights: âœ… Full Access"
        Write-Host "========================================"
        Write-Host ""

    - name: Keep Session Active
      run: |
        Write-Host "ğŸŸ¢ RDP Session Started - Keeping alive for 72 hours..."
        for ($i=0; $i -lt 864; $i++) {
            $remaining = (864 - $i) * 5
            $hours = [math]::Floor($remaining / 60)
            $minutes = $remaining % 60
            Write-Host "â±ï¸  RDP Active - $hoursh $minutesm remaining"
            Start-Sleep -Seconds 300
        }
